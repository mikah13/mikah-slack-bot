{"version":3,"sources":["spark-core.js"],"names":["registerPlugin","registerInternalPlugin","interceptors","SparkTrackingIdInterceptor","create","RequestEventInterceptor","RequestLoggerInterceptor","process","env","ENABLE_NETWORK_LOGGING","ENABLE_VERBOSE_NETWORK_LOGGING","undefined","ResponseLoggerInterceptor","RequestTimingInterceptor","UrlInterceptor","SparkUserAgentInterceptor","AuthInterceptor","KmsDryErrorInterceptor","PayloadTransformerInterceptor","ConversationInterceptor","RedirectInterceptor","HttpStatusInterceptor","error","NetworkTimingInterceptor","preInterceptors","postInterceptors","SparkCore","extend","version","children","internal","constructor","attrs","options","credentials","supertoken","access_token","forEach","path","val","derived","boundedStorage","deps","fn","unboundedStorage","ready","loaded","_children","reduce","name","session","config","type","default","request","setOnce","sessionId","refresh","transform","direction","object","predicates","payloadTransformer","filter","p","ctx","spark","all","map","test","then","shouldTransform","extract","target","data","d","Boolean","promise","alias","applyNamedTransform","resolve","rest","unshift","args","transforms","tx","getWindow","window","initialize","trigger","onLoaded","stopListening","nextTick","listenToAndRun","onReady","prototype","key","listenTo","addInterceptor","ints","interceptor","push","includes","json","v4","inspect","depth","serialize","props","logout","onBeforeLogout","reverse","plugin","clear","invalidate","authorization","measure","metrics","sendUnstructured","upload","file","reject","Error","phases","finalize","method","withCredentials","body","headers","shunt","_uploadPhaseInitialize","_uploadPhaseUpload","_uploadPhaseFinalize","res","logger","debug","_uploadApplySession","opts","phaseOptions","phaseKey","startsWith","substr","NODE_ENV","on","event","info","total"],"mappings":"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","file":"spark-core.js","sourcesContent":["/**!\n *\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n * @private\n */\n\nimport {proxyEvents, retry, transferEvents} from '@ciscospark/common';\nimport {HttpStatusInterceptor, defaults as requestDefaults} from '@ciscospark/http-core';\nimport {defaults, get, has, isFunction, isString, last, merge, omit, set, unset} from 'lodash';\nimport AmpState from 'ampersand-state';\nimport AuthInterceptor from './interceptors/auth';\nimport NetworkTimingInterceptor from './interceptors/network-timing';\nimport PayloadTransformerInterceptor from './interceptors/payload-transformer';\nimport RedirectInterceptor from './interceptors/redirect';\nimport RequestEventInterceptor from './interceptors/request-event';\nimport RequestLoggerInterceptor from './interceptors/request-logger';\nimport RequestTimingInterceptor from './interceptors/request-timing';\nimport ResponseLoggerInterceptor from './interceptors/response-logger';\nimport SparkHttpError from './lib/spark-http-error';\nimport SparkTrackingIdInterceptor from './interceptors/spark-tracking-id';\nimport SparkUserAgentInterceptor from './interceptors/spark-user-agent';\nimport config from './config';\nimport {makeSparkStore} from './lib/storage';\nimport util from 'util';\nimport uuid from 'uuid';\nimport {EventEmitter} from 'events';\nimport mixinSparkCorePlugins from './lib/spark-core-plugin-mixin';\nimport mixinSparkInternalCorePlugins from './lib/spark-internal-core-plugin-mixin';\nimport SparkInternalCore from './spark-internal-core';\n\n// TODO replace the Interceptor.create with Reflect.construct (\n// Interceptor.create exists because new was really hard to call on an array of\n// constructors)\nconst interceptors = {\n  SparkTrackingIdInterceptor: SparkTrackingIdInterceptor.create,\n  RequestEventInterceptor: RequestEventInterceptor.create,\n  /* eslint-disable no-extra-parens */\n  RequestLoggerInterceptor: (process.env.ENABLE_NETWORK_LOGGING || process.env.ENABLE_VERBOSE_NETWORK_LOGGING) ? RequestLoggerInterceptor.create : undefined,\n  ResponseLoggerInterceptor: (process.env.ENABLE_NETWORK_LOGGING || process.env.ENABLE_VERBOSE_NETWORK_LOGGING) ? ResponseLoggerInterceptor.create : undefined,\n  /* eslint-enable no-extra-parens */\n  RequestTimingInterceptor: RequestTimingInterceptor.create,\n  UrlInterceptor: undefined,\n  SparkUserAgentInterceptor: SparkUserAgentInterceptor.create,\n  AuthInterceptor: AuthInterceptor.create,\n  KmsDryErrorInterceptor: undefined,\n  PayloadTransformerInterceptor: PayloadTransformerInterceptor.create,\n  ConversationInterceptor: undefined,\n  RedirectInterceptor: RedirectInterceptor.create,\n  HttpStatusInterceptor() {\n    return HttpStatusInterceptor.create({\n      error: SparkHttpError\n    });\n  },\n  NetworkTimingInterceptor: NetworkTimingInterceptor.create\n};\n\nconst preInterceptors = [\n  `ResponseLoggerInterceptor`,\n  `RequestTimingInterceptor`,\n  `RequestEventInterceptor`,\n  `SparkTrackingIdInterceptor`\n];\n\nconst postInterceptors = [\n  `HttpStatusInterceptor`,\n  `NetworkTimingInterceptor`,\n  `RequestLoggerInterceptor`\n];\n\n/**\n * @class\n */\nconst SparkCore = AmpState.extend({\n  version: PACKAGE_VERSION,\n\n  children: {\n    internal: SparkInternalCore\n  },\n\n  constructor(attrs = {}, options) {\n    if (typeof attrs === `string`) {\n      attrs = {\n        credentials: {\n          supertoken: {\n              // eslint-disable-next-line camelcase\n            access_token: attrs\n          }\n        }\n      };\n    }\n    else {\n        // Reminder: order is important here\n      [\n        `credentials.authorization`,\n        `authorization`,\n        `credentials.supertoken.supertoken`,\n        `supertoken`,\n        `access_token`,\n        `credentials.authorization.supertoken`\n      ].forEach((path) => {\n        const val = get(attrs, path);\n        if (val) {\n          unset(attrs, path);\n          set(attrs, `credentials.supertoken`, val);\n        }\n      });\n\n      [\n        `credentials`,\n        `credentials.authorization`\n      ]\n        .forEach((path) => {\n          const val = get(attrs, path);\n          if (typeof val === `string`) {\n            unset(attrs, path);\n            set(attrs, `credentials.supertoken`, val);\n          }\n        });\n\n      if (typeof get(attrs, `credentials.access_token`) === `string`) {\n        set(attrs, `credentials.supertoken`, attrs.credentials);\n      }\n    }\n\n    return Reflect.apply(AmpState, this, [attrs, options]);\n  },\n\n  derived: {\n    boundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkStore(`bounded`, this);\n      }\n    },\n    unboundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkStore(`unbounded`, this);\n      }\n    },\n    ready: {\n      deps: [`loaded`, `internal.ready`],\n      fn() {\n        return this.loaded && Object.keys(this._children).reduce((ready, name) => ready && this[name] && this[name].ready !== false, true);\n      }\n    }\n  },\n\n  session: {\n    config: {\n      type: `object`\n    },\n    /**\n     * When true, indicates that the initial load from the storage layer is\n     * complete\n     * @instance\n     * @memberof SparkCore\n     * @type {boolean}\n     */\n    loaded: {\n      default: false,\n      type: `boolean`\n    },\n    request: {\n      setOnce: true,\n      // It's supposed to be a function, but that's not a type defined in\n      // Ampersand\n      type: `any`\n    },\n    sessionId: {\n      setOnce: true,\n      type: `string`\n    }\n  },\n\n  /**\n   * @instance\n   * @memberof SparkCore\n   * @param {[type]} args\n   * @returns {[type]}\n   */\n  refresh(...args) {\n    return this.credentials.refresh(...args);\n  },\n\n  /**\n   * Applies the directionally appropriate transforms to the specified object\n   * @param {string} direction\n   * @param {Object} object\n   * @returns {Promise}\n   */\n  transform(direction, object) {\n    const predicates = this.config.payloadTransformer.predicates.filter((p) => !p.direction || p.direction === direction);\n    const ctx = {\n      spark: this\n    };\n    return Promise.all(predicates.map((p) => p.test(ctx, object)\n      .then((shouldTransform) => {\n        if (!shouldTransform) {\n          return undefined;\n        }\n        return p.extract(object)\n          // eslint-disable-next-line max-nested-callbacks\n          .then((target) => ({\n            name: p.name,\n            target\n          }));\n      })))\n      .then((data) => data\n        .filter((d) => Boolean(d))\n        // eslint-disable-next-line max-nested-callbacks\n        .reduce((promise, {name, target, alias}) => promise.then(() => {\n          if (alias) {\n            return this.applyNamedTransform(direction, alias, target);\n          }\n          return this.applyNamedTransform(direction, name, target);\n        }), Promise.resolve()))\n      .then(() => object);\n  },\n\n  /**\n   * Applies the directionally appropriate transform to the specified parameters\n   * @param {string} direction\n   * @param {Object} ctx\n   * @param {string} name\n   * @returns {Promise}\n   */\n  applyNamedTransform(direction, ctx, name, ...rest) {\n    if (isString(ctx)) {\n      rest.unshift(name);\n      name = ctx;\n      ctx = {\n        spark: this,\n        transform: (...args) => this.applyNamedTransform(direction, ctx, ...args)\n      };\n    }\n\n    const transforms = ctx.spark.config.payloadTransformer.transforms.filter((tx) => tx.name === name && (!tx.direction || tx.direction === direction));\n    // too many implicit returns on the same line is difficult to interpret\n    // eslint-disable-next-line arrow-body-style\n    return transforms.reduce((promise, tx) => promise.then(() => {\n      if (tx.alias) {\n        return ctx.transform(tx.alias, ...rest);\n      }\n      return Promise.resolve(tx.fn(ctx, ...rest));\n    }), Promise.resolve())\n      .then(() => last(rest));\n  },\n\n  /**\n   * @private\n   * @returns {Window}\n   */\n  getWindow() {\n    // eslint-disable-next-line\n    return window;\n  },\n\n  /**\n   * Initializer\n   *\n   * @emits SparkCore#loaded\n   * @emits SparkCore#ready\n   * @instance\n   * @memberof SparkCore\n   * @param {Object} attrs\n   * @returns {SparkCore}\n   */\n  initialize(attrs = {}) {\n    this.config = merge({}, config, attrs.config);\n\n    // There's some unfortunateness with the way {@link AmpersandState#children}\n    // get initialized. We'll fire the change:config event so that\n    // {@link SparkPlugin#initialize()} can use\n    // `this.listenToOnce(parent, 'change:config', () => {});` to act on config\n    // during initialization\n    this.trigger(`change:config`);\n\n    const onLoaded = () => {\n      if (this.loaded) {\n        /**\n         * Fires when all data has been loaded from the storage layer\n         * @event loaded\n         * @instance\n         * @memberof SparkCore\n         */\n        this.trigger(`loaded`);\n\n        this.stopListening(this, `change:loaded`, onLoaded);\n      }\n    };\n\n    // This needs to run on nextTick or we'll never be able to wire up listeners\n    process.nextTick(() => {\n      this.listenToAndRun(this, `change:loaded`, onLoaded);\n    });\n\n    const onReady = () => {\n      if (this.ready) {\n        /**\n         * Fires when all plugins have fully initialized\n         * @event ready\n         * @instance\n         * @memberof SparkCore\n         */\n        this.trigger(`ready`);\n\n        this.stopListening(this, `change:ready`, onReady);\n      }\n    };\n\n    // This needs to run on nextTick or we'll never be able to wire up listeners\n    process.nextTick(() => {\n      this.listenToAndRun(this, `change:ready`, onReady);\n    });\n\n    // Make nested events propagate in a consistent manner\n    Object.keys(this.constructor.prototype._children).forEach((key) => {\n      this.listenTo(this[key], `change`, (...args) => {\n        args.unshift(`change:${key}`);\n        this.trigger(...args);\n      });\n    });\n\n    const addInterceptor = (ints, key) => {\n      const interceptor = interceptors[key];\n\n      if (!isFunction(interceptor)) {\n        return ints;\n      }\n\n      ints.push(Reflect.apply(interceptor, this, []));\n\n      return ints;\n    };\n\n    let ints = [];\n    ints = preInterceptors.reduce(addInterceptor, ints);\n    ints = Object.keys(interceptors).filter((key) => !(preInterceptors.includes(key) || postInterceptors.includes(key))).reduce(addInterceptor, ints);\n    ints = postInterceptors.reduce(addInterceptor, ints);\n\n    this.request = requestDefaults({\n      json: true,\n      interceptors: ints\n    });\n\n    let sessionId = `${get(this, `config.trackingIdPrefix`, `spark-js-sdk`)}_${get(this, `config.trackingIdBase`, uuid.v4())}`;\n    if (has(this, `config.trackingIdPrefix`)) {\n      sessionId += `_${get(this, `config.trackingIdPrefix`)}`;\n    }\n\n    this.sessionId = sessionId;\n  },\n\n  /**\n   * @instance\n   * @memberof SparkPlugin\n   * @param {number} depth\n   * @private\n   * @returns {Object}\n   */\n  inspect(depth) {\n    return util.inspect(omit(this.serialize({\n      props: true,\n      session: true,\n      derived: true\n    }), `boundedStorage`, `unboundedStorage`, `request`, `config`), {depth});\n  },\n\n  /**\n   * Invokes all `onBeforeLogout` handlers in the scope of their plugin, clears\n   * all stores, and revokes the access token\n   * Note: If you're using the sdk in a server environment, you may be more\n   * interested in {@link `spark.internal.mercury.disconnect()`| Mercury#disconnect()}\n   * and {@link `spark.internal.device.unregister()`|Device#unregister()}\n   * or {@link `spark.phone.unregister()`|Phone#unregister}\n   * @instance\n   * @memberof SparkCore\n   * @param {Object} options Passed as the first argument to all\n   * `onBeforeLogout` handlers\n   * @returns {Promise}\n   */\n  logout(...args) {\n    // onBeforeLogout should be executed in the opposite order in which handlers\n    // were registered. In that way, wdm unregister() will be above mercury\n    // disconnect(), but disconnect() will execute first.\n    return this.config.onBeforeLogout.reverse().reduce((promise, {plugin, fn}) => promise.then(() => Reflect.apply(fn, this[plugin] || this.internal[plugin], args)), Promise.resolve())\n      .then(() => Promise.all([\n        this.boundedStorage.clear(),\n        this.unboundedStorage.clear()\n      ]))\n      .then(() => this.credentials.invalidate(...args))\n      .then(() => this.authorization && this.authorization.logout && this.authorization.logout(...args))\n      .then(() => this.trigger(`client:logout`));\n  },\n\n  /**\n   * General purpose wrapper to submit metrics via the metrics plugin (if the\n   * metrics plugin is installed)\n   * @instance\n   * @memberof SparkCore\n   * @returns {Promise}\n   */\n  measure(...args) {\n    if (this.metrics) {\n      return this.metrics.sendUnstructured(...args);\n    }\n\n    return Promise.resolve();\n  },\n\n  upload(options) {\n    if (!options.file) {\n      return Promise.reject(new Error(`\\`options.file\\` is required`));\n    }\n\n    options.phases = options.phases || {};\n    options.phases.initialize = options.phases.initialize || {};\n    options.phases.upload = options.phases.upload || {};\n    options.phases.finalize = options.phases.finalize || {};\n\n    defaults(options.phases.initialize, {\n      method: `POST`\n    }, omit(options, `file`, `phases`));\n\n    defaults(options.phases.upload, {\n      method: `PUT`,\n      json: false,\n      withCredentials: false,\n      body: options.file,\n      headers: {\n        'x-trans-id': uuid.v4(),\n        authorization: undefined\n      }\n    });\n\n    defaults(options.phases.finalize, {\n      method: `POST`\n    }, omit(options, `file`, `phases`));\n\n    const shunt = new EventEmitter();\n\n    const promise = this._uploadPhaseInitialize(options)\n      .then(() => {\n        const p = this._uploadPhaseUpload(options);\n        transferEvents(`progress`, p, shunt);\n        return p;\n      })\n      .then((...args) => this._uploadPhaseFinalize(options, ...args))\n      .then((res) => res.body);\n\n    proxyEvents(shunt, promise);\n\n    return promise;\n  },\n\n  _uploadPhaseInitialize: function _uploadPhaseInitialize(options) {\n    this.logger.debug(`client: initiating upload session`);\n\n    return this.request(options.phases.initialize)\n      .then((...args) => this._uploadApplySession(options, ...args))\n      .then((res) => {\n        this.logger.debug(`client: initiated upload session`);\n        return res;\n      });\n  },\n\n  _uploadApplySession(options, res) {\n    const session = res.body;\n    [`upload`, `finalize`].reduce((opts, key) => {\n      opts[key] = Object.keys(opts[key]).reduce((phaseOptions, phaseKey) => {\n        if (phaseKey.startsWith(`$`)) {\n          phaseOptions[phaseKey.substr(1)] = phaseOptions[phaseKey](session);\n          Reflect.deleteProperty(phaseOptions, phaseKey);\n        }\n\n        return phaseOptions;\n      }, opts[key]);\n\n      return opts;\n    }, options.phases);\n  },\n\n  @retry\n  _uploadPhaseUpload(options) {\n    this.logger.debug(`client: uploading file`);\n\n    const promise = this.request(options.phases.upload)\n      .then((res) => {\n        this.logger.debug(`client: uploaded file`);\n        return res;\n      });\n\n    proxyEvents(options.phases.upload.upload, promise);\n\n    /* istanbul ignore else */\n    if (process.env.NODE_ENV === `test`) {\n      promise.on(`progress`, (event) => {\n        this.logger.info(`upload progress`, event.loaded, event.total);\n      });\n    }\n\n    return promise;\n  },\n\n  _uploadPhaseFinalize: function _uploadPhaseFinalize(options) {\n    this.logger.debug(`client: finalizing upload session`);\n\n    return this.request(options.phases.finalize)\n      .then((res) => {\n        this.logger.debug(`client: finalized upload session`);\n        return res;\n      });\n  }\n});\n\nSparkCore.version = PACKAGE_VERSION;\n\nmixinSparkInternalCorePlugins(SparkInternalCore, config, interceptors);\nmixinSparkCorePlugins(SparkCore, config, interceptors);\n\nexport default SparkCore;\n\n/**\n * @method registerPlugin\n * @param {string} name\n * @param {function} constructor\n * @param {Object} options\n * @param {Array<string>} options.proxies\n * @param {Object} options.interceptors\n * @returns {null}\n */\nexport function registerPlugin(name, constructor, options) {\n  SparkCore.registerPlugin(name, constructor, options);\n}\n\n/**\n * Registers plugins used by internal products that do not talk to public APIs.\n * @method registerInternalPlugin\n * @param {string} name\n * @param {function} constructor\n * @param {Object} options\n * @param {Object} options.interceptors\n * @private\n * @returns {null}\n */\nexport function registerInternalPlugin(name, constructor, options) {\n  SparkInternalCore.registerPlugin(name, constructor, options);\n}\n"]}